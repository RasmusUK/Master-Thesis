<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Git\Master-Thesis\EventSourcingFramework\src\EventSourcingFramework.Infrastructure.Http\Services\ApiGateway.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Text;
using EventSourcingFramework.Application.Abstractions.ApiGateway;
using EventSourcingFramework.Application.Abstractions.EventStore;
using EventSourcingFramework.Application.Abstractions.ReplayContext;
using EventSourcingFramework.Core.Enums;
using EventSourcingFramework.Core.Interfaces;
using Newtonsoft.Json;

namespace EventSourcingFramework.Infrastructure.Http.Services;

public class ApiGateway : IApiGateway
{
    private readonly HttpClient httpClient;
    private readonly IReplayContext replayContext;
    private readonly IApiResponseStore responseStore;
    private readonly IEventSequenceGenerator sequenceGenerator;

    public ApiGateway(HttpClient httpClient, IApiResponseStore responseStore, IReplayContext replayContext, IEventSequenceGenerator sequenceGenerator)
    {
        this.httpClient = httpClient;
        this.responseStore = responseStore;
        this.replayContext = replayContext;
        this.sequenceGenerator = sequenceGenerator;
    }

    public async Task&lt;T&gt; GetAsync&lt;T&gt;(string url, Dictionary&lt;string, string&gt;? headers = null)
    {
        var key = $&quot;GET:{url}&quot;;
        return await HandleRequest&lt;T&gt;(() =&gt; BuildRequest&lt;T&gt;(HttpMethod.Get, url, default, headers), key);
    }

    public async Task&lt;TResponse&gt; PostAsync&lt;TRequest, TResponse&gt;(string url, TRequest body,
        Dictionary&lt;string, string&gt;? headers = null)
    {
        var key = $&quot;POST:{url}:{JsonConvert.SerializeObject(body)}&quot;;
        return await HandleRequest&lt;TResponse&gt;(() =&gt; BuildRequest(HttpMethod.Post, url, body, headers), key);
    }

    public async Task&lt;TResponse&gt; SendAsync&lt;TResponse&gt;(HttpRequestMessage request)
    {
        var content = request.Content is not null
            ? await request.Content.ReadAsStringAsync()
            : &quot;&quot;;
        var key = $&quot;{request.Method}:{request.RequestUri}:{content}&quot;;
        return await HandleRequest&lt;TResponse&gt;(() =&gt; Task.FromResult(request), key);
    }

    private async Task&lt;T&gt; HandleRequest&lt;T&gt;(Func&lt;Task&lt;HttpRequestMessage&gt;&gt; buildRequest, string key)
    {
        if (replayContext.IsReplaying)
            switch (replayContext.ApiReplayMode)
            {
                case ApiReplayMode.CacheOnly:
                {
                    var cached = await responseStore.GetAsync&lt;T&gt;(key, replayContext.EventNumber);
                    if (cached is not null)
                        return cached;

                    throw new InvalidOperationException(
                        $&quot;No cached response found for key &#39;{key}&#39; during replay with StorageOnly mode.&quot;);
                }

                case ApiReplayMode.ExternalOnly:
                {
                    var request = await buildRequest();
                    var response = await httpClient.SendAsync(request);
                    response.EnsureSuccessStatusCode();

                    var json = await response.Content.ReadAsStringAsync();
                    var result = JsonConvert.DeserializeObject&lt;T&gt;(json);

                    return result!;
                }

                case ApiReplayMode.CacheThenExternal:
                {
                    var cached = await responseStore.GetAsync&lt;T&gt;(key, replayContext.EventNumber);
                    if (cached is not null)
                        return cached;

                    var request = await buildRequest();
                    var response = await httpClient.SendAsync(request);
                    response.EnsureSuccessStatusCode();

                    var json = await response.Content.ReadAsStringAsync();
                    var result = JsonConvert.DeserializeObject&lt;T&gt;(json);

                    return result!;
                }

                default:
                    throw new InvalidOperationException($&quot;Unsupported replay mode: {replayContext.ReplayMode}&quot;);
            }

        var liveRequest = await buildRequest();
        var liveResponse = await httpClient.SendAsync(liveRequest);
        liveResponse.EnsureSuccessStatusCode();

        var liveJson = await liveResponse.Content.ReadAsStringAsync();
        var liveResult = JsonConvert.DeserializeObject&lt;T&gt;(liveJson);

        await responseStore.SaveAsync(key, await sequenceGenerator.GetCurrentSequenceNumberAsync(), liveResult!);
        return liveResult!;
    }

    private Task&lt;HttpRequestMessage&gt; BuildRequest&lt;T&gt;(HttpMethod method, string url, T? body,
        Dictionary&lt;string, string&gt;? headers)
    {
        var request = new HttpRequestMessage(method, url);

        if (headers is not null)
            foreach (var kv in headers)
                request.Headers.Add(kv.Key, kv.Value);

        if (body == null) return Task.FromResult(request);

        var json = JsonConvert.SerializeObject(body);
        request.Content = new StringContent(json, Encoding.UTF8, &quot;application/json&quot;);

        return Task.FromResult(request);
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[18,5,18,151,1],[19,5,19,6,1],[20,9,20,38,1],[21,9,21,44,1],[22,9,22,44,1],[23,9,23,52,1],[24,5,24,6,1],[27,5,27,6,1],[28,9,28,32,1],[29,9,29,45,1],[29,45,29,99,1],[29,99,29,106,1],[30,5,30,6,1],[34,5,34,6,1],[35,9,35,69,1],[36,9,36,53,1],[36,53,36,102,1],[36,102,36,109,1],[37,5,37,6,1],[40,5,40,6,1],[41,9,43,18,1],[44,9,44,70,1],[45,9,45,53,1],[45,53,45,77,1],[45,77,45,84,1],[46,5,46,6,1],[49,5,49,6,1],[50,9,50,39,1],[51,13,51,49,1],[54,17,54,18,1],[55,21,55,98,1],[56,21,56,44,1],[57,25,57,39,1],[59,21,60,107,1],[64,17,64,18,1],[65,21,65,56,1],[66,21,66,72,1],[67,21,67,56,1],[69,21,69,75,1],[70,21,70,73,1],[72,21,72,36,1],[76,17,76,18,1],[77,21,77,98,1],[78,21,78,44,1],[79,25,79,39,1],[81,21,81,56,1],[82,21,82,72,1],[83,21,83,56,1],[85,21,85,75,1],[86,21,86,73,1],[88,21,88,36,1],[92,21,92,113,0],[95,9,95,48,1],[96,9,96,68,1],[97,9,97,48,1],[99,9,99,71,1],[100,9,100,69,1],[102,9,102,114,1],[103,9,103,28,1],[104,5,104,6,1],[108,5,108,6,1],[109,9,109,59,1],[111,9,111,33,1],[112,13,112,20,0],[112,22,112,28,0],[112,29,112,31,0],[112,32,112,39,0],[113,17,113,55,0],[115,9,115,26,1],[115,27,115,59,1],[117,9,117,54,1],[118,9,118,86,1],[120,9,120,41,1],[121,5,121,6,1]]);
    </script>
  </body>
</html>