<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Git\Master-Thesis\EventSourcingFramework\src\EventSourcingFramework.Infrastructure.Stores\ApiResponseStore\ApiResponseStore.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using EventSourcingFramework.Core.Interfaces;
using EventSourcingFramework.Infrastructure.Shared.Interfaces;
using EventSourcingFramework.Infrastructure.Shared.Models;
using MongoDB.Bson;
using MongoDB.Bson.Serialization;
using MongoDB.Driver;

namespace EventSourcingFramework.Infrastructure.Stores.ApiResponseStore;

public class ApiResponseStore : IApiResponseStore
{
    private readonly IMongoCollection&lt;MongoApiResponse&gt; collection;

    public ApiResponseStore(IMongoDbService mongoDbService)
    {
        collection = mongoDbService.ApiResponseCollection;
    }

    public async Task&lt;T?&gt; GetAsync&lt;T&gt;(string key, long eventNumber)
    {
        var filter = Builders&lt;MongoApiResponse&gt;.Filter.And(
            Builders&lt;MongoApiResponse&gt;.Filter.Eq(x =&gt; x.Key, key),
            Builders&lt;MongoApiResponse&gt;.Filter.Lte(x =&gt; x.EventNumber, eventNumber)
        );

        var doc = await collection
            .Find(filter)
            .SortByDescending(x =&gt; x.EventNumber)
            .FirstOrDefaultAsync();

        return doc is not null 
            ? BsonSerializer.Deserialize&lt;T&gt;(doc.Response) 
            : default;
    }

    public async Task SaveAsync&lt;T&gt;(string key, long eventNumber, T response)
    {
        var document = new MongoApiResponse
        {
            Key = key,
            Response = response.ToBsonDocument(),
            CreatedAt = DateTime.UtcNow,
            EventNumber = eventNumber
        };

        await collection.InsertOneAsync(document);
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[14,5,14,60,1],[15,5,15,6,1],[16,9,16,59,1],[17,5,17,6,1],[20,5,20,6,1],[21,9,24,11,1],[26,9,29,36,1],[31,9,33,23,1],[34,5,34,6,1],[37,5,37,6,1],[38,9,44,11,1],[46,9,46,51,1],[47,5,47,6,1]]);
    </script>
  </body>
</html>