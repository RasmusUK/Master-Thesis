<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Git\Master-Thesis\EventSourcingFramework\src\EventSourcingFramework.Application\UseCases\EntityHistory\EntityHistoryService.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using EventSourcingFramework.Application.Abstractions.EntityHistory;
using EventSourcingFramework.Core.Interfaces;
using EventSourcingFramework.Core.Models.Entity;
using EventSourcingFramework.Core.Models.Events;

namespace EventSourcingFramework.Application.UseCases.EntityHistory;

public class EntityHistoryService : IEntityHistoryService
{
    private readonly IEventStore eventStore;

    public EntityHistoryService(IEventStore eventStore)
    {
        this.eventStore = eventStore;
    }

    public async Task&lt;IReadOnlyCollection&lt;T&gt;&gt; GetEntityHistoryAsync&lt;T&gt;(Guid id)
        where T : IEntity
    {
        return (await GetEntityHistoryWithEventsAsync&lt;T&gt;(id)).Select(e =&gt; e.entity).ToList();
    }

    public async Task&lt;IReadOnlyCollection&lt;(T entity, IEvent e)&gt;&gt; GetEntityHistoryWithEventsAsync&lt;T&gt;(
        Guid id
    )
        where T : IEntity
    {
        var events = await eventStore.GetEventsByEntityIdAsync(id);
        var entitiesWithEvents = new List&lt;(T, IEvent)&gt;();

        foreach (var e in events)
        {
            var entity = GetEntityFromRepoEvent&lt;T&gt;(e);
            entitiesWithEvents.Add((entity, e));
        }

        return entitiesWithEvents;
    }

    private static T GetEntityFromRepoEvent&lt;T&gt;(IEvent e)
        where T : IEntity
    {
        dynamic dynEvent = e;
        return (T)dynEvent.Entity;
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,5,12,56,1],[13,5,13,6,1],[14,9,14,38,1],[15,5,15,6,1],[19,5,19,6,1],[20,9,20,75,1],[20,75,20,83,1],[20,83,20,94,1],[21,5,21,6,1],[27,5,27,6,1],[28,9,28,68,1],[29,9,29,58,1],[31,9,31,16,1],[31,18,31,23,1],[31,24,31,26,1],[31,27,31,33,1],[32,9,32,10,1],[33,13,33,55,1],[34,13,34,49,1],[35,9,35,10,1],[37,9,37,35,1],[38,5,38,6,1],[42,5,42,6,1],[43,9,43,30,1],[44,9,44,35,1],[45,5,45,6,1]]);
    </script>
  </body>
</html>